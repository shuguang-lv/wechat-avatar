(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/index/index"],{"0901":function(t,e,a){"use strict";a.r(e);var n=a("c0ae"),i=a("8d1c");for(var s in i)"default"!==s&&function(t){a.d(e,t,(function(){return i[t]}))}(s);a("5a9d");var r,o=a("f0c5"),c=Object(o["a"])(i["default"],n["b"],n["c"],!1,null,"5f9bb598",null,!1,n["a"],r);e["default"]=c.exports},"5a9d":function(t,e,a){"use strict";var n=a("bd7d"),i=a.n(n);i.a},"8d1c":function(t,e,a){"use strict";a.r(e);var n=a("e7a7"),i=a.n(n);for(var s in n)"default"!==s&&function(t){a.d(e,t,(function(){return n[t]}))}(s);e["default"]=i.a},bd7d:function(t,e,a){},c0ae:function(t,e,a){"use strict";var n;a.d(e,"b",(function(){return i})),a.d(e,"c",(function(){return s})),a.d(e,"a",(function(){return n}));var i=function(){var t=this,e=t.$createElement;t._self._c},s=[]},e7a7:function(t,e,a){"use strict";(function(t,n){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=s(a("a34a"));s(a("62af")),a("1d06");function s(t){return t&&t.__esModule?t:{default:t}}function r(t,e,a,n,i,s,r){try{var o=t[s](r),c=o.value}catch(u){return void a(u)}o.done?e(c):Promise.resolve(c).then(n,i)}function o(t){return function(){var e=this,a=arguments;return new Promise((function(n,i){var s=t.apply(e,a);function o(t){r(s,n,i,o,c,"next",t)}function c(t){r(s,n,i,o,c,"throw",t)}o(void 0)}))}}var c={data:function(){return{poster:{},posterImage:"",canvasId:"default_PosterCanvasId",userInfo:"",code:"",avatarImage:t.getStorageSync("avatar_image"),indexBg:{},defaultImage:"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-08ecbb66-149e-4d2b-93a0-fa6bc6e0e894/c33782ca-cd2f-4bfc-84eb-0713c52f522f.svg",currentImage:{},currentIndex:0,imageList:t.getStorageSync("first_image_list")||[],categoriesList:t.getStorageSync("image_categories_list")||[],shareInfo:{},adInfo:{},adState:!0,showBorder:!0,maskCenterX:t.upx2px(590)/2,maskCenterY:t.upx2px(590)/2,handleCenterX:t.upx2px(560),handleCenterY:t.upx2px(570),handleWidth:50,maskSize:t.upx2px(590),scale:1,rotate:0,mask_center_x:t.upx2px(590)/2,mask_center_y:t.upx2px(590)/2,handle_center_x:t.upx2px(560),handle_center_y:t.upx2px(570),scaleCurrent:1,rotateCurrent:0,touch_target:"",start_x:0,start_y:0,startInfo:0,cansBorder:t.upx2px(590),imageScale:10,bgIndex:0}},onLoad:function(){this.init(),this.initBg(),this.getCategoriesList()},onShow:function(){this.getShareInfo()},onReady:function(){var t=this,e=wx.createSelectorQuery();e.select(".avatar-div").boundingClientRect(),e.exec((function(e){t.startInfo=e[0]}))},onShareAppMessage:function(){return this.shareInfo},onShareTimeline:function(){return this.shareInfo},methods:{getShareInfo:function(){var e=this;t.showLoading({title:"Loading...",mask:!0}),n.callFunction({name:"code-mag",data:{type:"mpweixinGet"}}).then((function(a){a.result.data&&a.result.data.length>0&&(e.shareInfo=a.result.data.find((function(t){return"mpwx_share"===t.code})),t.setStorageSync("shareInfo",e.shareInfo),t.setStorageSync("background_info",a.result.data))})).catch((function(e){t.showModal({content:e.message||"Fail to request service",showCancel:!1})})).finally((function(){t.hideLoading()}))},getCategoriesList:function(){var e=this;t.showLoading({title:"Loading...",mask:!0}),n.callFunction({name:"categories",data:{type:"mpweixin"}}).then((function(a){e.categoriesList=a.result.data,t.setStorageSync("image_categories_list",a.result.data),e.categoriesList.length>0&&(e.$set(e.categoriesList[0],"selected",!0),e.getImagesList(e.categoriesList[0]._id,"","storage"))})).catch((function(e){t.showModal({content:e.message||"Fail to request service",showCancel:!1})})).finally((function(){t.hideLoading()}))},getImagesList:function(e,a,i){var s=this;t.showLoading({title:"Loading...",mask:!0}),n.callFunction({name:"images",data:{type:"mpweixin",categoryId:e}}).then((function(e){s.imageList=e.result.data,"storage"===i&&t.setStorageSync("first_image_list",e.result.data),s.imageList&&s.imageList.length>0&&(s.currentImage=a<0?s.imageList[s.imageList.length-1]:s.imageList[0],s.currentImage&&s.currentImage.drag_state||s.initImage())})).catch((function(e){t.showModal({content:e.message||"Fail to request service",showCancel:!1})})).finally((function(){t.hideLoading()}))},init:function(){var e=this;return o(i.default.mark((function a(){return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.next=2,e.getWeixinCode();case 2:e.code=a.sent,e.userInfo=t.getStorageSync("user_info");case 4:case"end":return a.stop()}}),a)})))()},initBg:function(){var e=this;if(t.getStorageSync("background_info")&&t.getStorageSync("background_info").length){var a=t.getStorageSync("background_info");this.shareInfo=a.find((function(t){return"mpwx_share"===t.code}))}else this.bgIndex<5?(this.bgIndex++,setTimeout((function(){e.initBg()}),300)):this.getShareInfo()},switchCategory:function(t,e){var a=this.categoriesList.filter((function(t){return t.selected}));a&&a.length>0&&(a[0].selected=!1),this.$set(t,"selected",!0),this.getImagesList(t._id,e)},switchAvatar:function(t){var e=this;this.touchAvatarBg(!0);var a=this.imageList.findIndex((function(t){return t._id===e.currentImage._id}));if(t>0&&a<this.imageList.length-1||t<0&&a>0)a+=t,this.currentImage=this.imageList[a];else{var n=this.categoriesList.findIndex((function(t){return t.selected}));n+=t,this.categoriesList[n]&&this.categoriesList[n]._id&&this.switchCategory(this.categoriesList[n],t)}this.$nextTick((function(){e.currentImage&&e.currentImage.drag_state||e.initImage()}))},touchStart:function(t){this.currentImage&&this.currentImage.drag_state&&("mask-img"==t.target.id?(this.touch_target="mask-img",this.showBorder=!0):"drag-img"==t.target.id?this.touch_target="drag-img":this.touch_target="",""!=this.touch_target&&(this.start_x=t.touches[0].clientX,this.start_y=t.touches[0].clientY))},touchMove:function(t){if(this.currentImage&&this.currentImage.drag_state){var e=t.touches[0].clientX,a=t.touches[0].clientY,n=e-this.start_x,i=a-this.start_y;if("mask-img"===this.touch_target&&(this.maskCenterX=this.maskCenterX+n,this.maskCenterY=this.maskCenterY+i,this.handleCenterX=this.handleCenterX+n,this.handleCenterY=this.handleCenterY+i),"drag-img"===this.touch_target){this.handleCenterX=this.handleCenterX+n,this.handleCenterY=this.handleCenterY+i;var s=this.handle_center_x-this.mask_center_x,r=this.handle_center_y-this.mask_center_y,o=this.handleCenterX-this.mask_center_x,c=this.handleCenterY-this.mask_center_y,u=Math.sqrt(s*s+r*r),h=Math.sqrt(o*o+c*c),g=Math.atan2(r,s)/Math.PI*180,d=Math.atan2(c,o)/Math.PI*180;this.scale=h/u*this.scaleCurrent,this.rotate=d-g+this.rotateCurrent;var l=100*this.scale;this.handleWidth=l>50?50:l<10?10:l}this.start_x=e,this.start_y=a}},touchEnd:function(t){this.currentImage&&this.currentImage.drag_state&&(this.mask_center_x=this.maskCenterX,this.mask_center_y=this.maskCenterY,this.handle_center_x=this.handleCenterX,this.handle_center_y=this.handleCenterY,this.touch_target="",this.scaleCurrent=this.scale,this.rotateCurrent=this.rotate)},touchAvatarBg:function(t){this.showBorder=t},imageClick:function(t,e){this.currentImage=t,this.currentIndex=e,this.currentImage&&this.currentImage.drag_state||this.initImage()},initImage:function(){this.showBorder=!0,this.maskCenterX=t.upx2px(590)/2,this.maskCenterY=t.upx2px(590)/2,this.handleCenterX=t.upx2px(560),this.handleCenterY=t.upx2px(570),this.maskSize=t.upx2px(590),this.scale=1,this.rotate=0,this.mask_center_x=t.upx2px(590)/2,this.mask_center_y=t.upx2px(590)/2,this.handle_center_x=t.upx2px(560),this.handle_center_y=t.upx2px(570),this.scaleCurrent=1,this.rotateCurrent=0,this.touch_target="",this.start_x=0,this.start_y=0},showSwitch:function(t){var e=this,a=this.categoriesList.findIndex((function(t){return t.selected})),n=this.imageList.findIndex((function(t){return t._id===e.currentImage._id})),i=t<0&&a<=0&&n<=0||t>0&&a>=this.categoriesList.length-1&&n>=this.imageList.length-1;return!i},getWeixinCode:function(){return new Promise((function(e,a){t.login({provider:"weixin",success:function(t){e(t.code)},fail:function(t){a(new Error("Fail to login"))}})}))},shareFc:function(){var e=this;return o(i.default.mark((function a(){var n,s,r;return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(e.avatarImage){a.next=3;break}return t.showToast({title:"Please fetch your avatar first",icon:"none"}),a.abrupt("return");case 3:t.showLoading({title:"Loading...",mask:!0}),n=t.createCanvasContext("default_PosterCanvasId",e),s=e.cansBorder,r=e.scale*s,n.scale(e.imageScale,e.imageScale),n.clearRect(0,0,e.cansBorder,e.cansBorder),t.getImageInfo({src:e.avatarImage,success:function(a){n.drawImage(a.path,0,0,s,s),t.getImageInfo({src:e.currentImage.image_url,success:function(t){n.translate(e.mask_center_x,e.mask_center_y),n.rotate(e.rotate*Math.PI/180),n.drawImage(t.path,-r/2,-r/2,r,r),n.draw(!1,(function(){e.saveCans()}))},fail:function(){n.draw(!1,(function(){e.saveCans()}))}})}});case 10:case"end":return a.stop()}}),a)})))()},saveCans:function(){var e=this;t.canvasToTempFilePath({x:0,y:0,height:this.cansBorder*this.imageScale,width:this.cansBorder*this.imageScale,destWidth:this.cansBorder*this.imageScale,destHeight:this.cansBorder*this.imageScale,canvasId:this.canvasId,fileType:"jpg",success:function(t){e.posterImage=t.tempFilePath,e.savefile()},fail:function(e){t.hideLoading()}},this)},savefile:function(){var e=this;t.getSetting({success:function(a){a.authSetting["scope.writePhotosAlbum"]?e.saveImgToLocal():t.authorize({scope:"scope.writePhotosAlbum",success:function(){e.saveImgToLocal()},fail:function(e){t.hideLoading(),wx.showModal({content:"It is detected that image downloading function is not permitted. Do you want to enable it now ?",confirmText:"Yes",cancelText:"No",success:function(t){t.confirm&&wx.openSetting()}})}})}})},saveImgToLocal:function(e){var a=this;t.saveImageToPhotosAlbum({filePath:a.posterImage,success:function(){a.saveImageInfo(),t.setStorageSync("currentImage",a.posterImage)},fail:function(e){t.hideLoading(),t.showToast({title:"Fail to save",icon:"none"})}})},saveImageInfo:function(){n.callFunction({name:"images",data:{imageInfo:this.currentImage,type:"imageUsed"}}).then((function(e){t.hideLoading(),t.navigateTo({url:"/pages/save-success/save-success"})}))},getUserProfile:function(e){var a=this;return o(i.default.mark((function n(){var s;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:s=a,t.getUserProfile({desc:"Fetch avatar information",success:function(a){var n={code:s.code,signature:a.signature,encrypted_data:a.encryptedData,iv:a.iv,userInfo:a.userInfo},i=n.userInfo.avatarUrl;"createImages"===e&&(s.avatarImage=i.substring(0,i.lastIndexOf("/")+1)+"0",t.setStorageSync("avatar_image",s.avatarImage)),s.postUserInfo(a.userInfo.nickName,e)},fail:function(e){console.log(e),t.showToast({icon:"error",position:"center",title:"Fail to fetch avatar information"})}});case 2:case"end":return n.stop()}}),n)})))()},postUserInfo:function(e,a){var s=this;return o(i.default.mark((function r(){var o;return i.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:return o=s,i.next=3,s.getWeixinCode();case 3:s.code=i.sent,"userLogin"!==a&&"selectedImage"!==a||t.showLoading({title:"Loading...",mask:!0}),n.callFunction({name:"user_mpweixin",data:{code:o.code,avatarImage:o.avatarImage,nickName:e,type:"selectedImage"===a?"userLogin":a}}).then((function(e){t.setStorageSync("user_info",e.result),s.userInfo=e.result,"userLogin"===a?(t.hideLoading(),s.navOriginal()):"selectedImage"===a&&s.chooseImages(a)})).catch((function(e){console.log(e),t.showToast({icon:"error",position:"center",title:"Fail to store user information"})}));case 6:case"end":return i.stop()}}),r)})))()},chooseImages:function(e){var a=this;t.hideLoading(),t.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(t){var i=t.tempFilePaths[0];n.uploadFile({filePath:i,cloudPath:"userChooseImage-".concat((new Date).getTime(),".png")}).then((function(t){n.getTempFileURL({fileList:[t["fileID"]]}).then((function(t){a.avatarImage=t.fileList[0].tempFileURL})),n.callFunction({name:"user_mpweixin",data:{userId:a.userInfo._id,avatarImage:a.avatarImage,type:e}}).then()}))}})},navOriginal:function(){t.navigateTo({url:"/pages/original-avatar/original-avatar"})},navSortition:function(){t.navigateTo({url:"/pages/sortition/sortition"})}}};e.default=c}).call(this,a("543d")["default"],a("a9ff")["default"])},ed53:function(t,e,a){"use strict";(function(t){a("0fc2");n(a("66fd"));var e=n(a("0901"));function n(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=a,t(e.default)}).call(this,a("543d")["createPage"])}},[["ed53","common/runtime","common/vendor"]]]);